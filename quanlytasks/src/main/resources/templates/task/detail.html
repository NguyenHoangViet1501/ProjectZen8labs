<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title th:text="${task.title + ' | Task Manager'}">Task Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" th:href="@{/tasks}">Task Manager</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" th:href="@{/notifications}">Thông báo</a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Tài khoản</a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <form th:action="@{/logout}" method="post">
                                <button type="submit" class="dropdown-item">Đăng xuất</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <main class="py-4">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="mb-3">
                <a th:href="@{/tasks}" class="text-decoration-none">← Quay lại danh sách</a>
            </nav>

            <!-- Success message -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                <span th:text="${success}">Success</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Error message -->
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                <span th:text="${error}">Error</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Deleted Task Alert for Admin -->
            <div th:if="${task.isDeleted && isAdmin}" class="deleted-task-alert">
                <strong> Task này đã bị xóa.</strong>
                Quay lại <a th:href="@{/tasks}">danh sách task</a> đổi trạng thái để hoàn tác.
            </div>

            <div class="row">
                <!-- Main Content -->
                <div class="col-lg-8">
                    <!-- Task Info Card -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge me-1"
                                    th:classappend="${task.priority.name() == 'HIGH'} ? 'priority-high' : (${task.priority.name() == 'MEDIUM'} ? 'priority-medium' : 'priority-low')"
                                    th:text="${task.priority.name() == 'HIGH'} ? 'Ưu tiên cao' : (${task.priority.name() == 'MEDIUM'} ? 'Ưu tiên TB' : 'Ưu tiên thấp')">
                                </span>
                                <span class="badge" th:classappend="'status-' + ${task.status.name().toLowerCase()}"
                                    th:switch="${task.status.name()}">
                                    <span th:case="'TODO'">Chờ xử lý</span>
                                    <span th:case="'IN_PROGRESS'">Đang thực hiện</span>
                                    <span th:case="'DONE'">Hoàn thành</span>
                                    <span th:case="'CANCELLED'">Đã hủy</span>
                                </span>
                            </div>
                            <!-- Hide edit menu for deleted tasks -->
                            <div class="dropdown" th:if="${!task.isDeleted}">
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">⋮</button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" th:href="@{/tasks/{id}/edit(id=${task.id})}">Sửa</a>
                                    </li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <button type="button" class="dropdown-item text-danger"
                                            onclick="showDeleteTaskModal()">
                                            Xóa
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <h4 class="mb-3" th:text="${task.title}">Task Title</h4>
                            <p th:text="${task.description ?: 'Không có mô tả'}">Description</p>

                            <!-- Tags -->
                            <div class="mb-3" th:if="${task.tags != null && task.tags.size() > 0}">
                                <span class="badge bg-secondary me-1" th:each="tag : ${task.tags}"
                                    th:text="${tag}">tag</span>
                            </div>

                            <!-- Meta Info -->
                            <div class="row g-3 mt-3 border-top pt-3">
                                <div class="col-6">
                                    <small class="text-muted d-block">Người tạo</small>
                                    <span th:text="${task.createdByName}">Creator</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Người thực hiện</small>
                                    <span th:text="${task.assigneeName ?: 'Chưa giao'}">Assignee</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Ngày tạo</small>
                                    <span
                                        th:text="${#temporals.format(task.createdAt, 'dd/MM/yyyy HH:mm')}">Created</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Deadline</small>
                                    <span
                                        th:text="${task.dueDate != null} ? ${#temporals.format(task.dueDate, 'dd/MM/yyyy HH:mm')} : 'Không có'">Due</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SubTasks -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Subtasks</span>
                            <!-- Hide add button when task is deleted -->
                            <button th:if="${!task.isDeleted && (task.createdById == currentUser.id || isAdmin)}"
                                class="btn btn-sm btn-primary" data-bs-toggle="collapse"
                                data-bs-target="#addSubtaskForm">+ Thêm</button>
                        </div>

                        <!-- Add Subtask Form -->
                        <div class="collapse" id="addSubtaskForm">
                            <div class="card-body border-bottom">
                                <form th:action="@{/tasks/{id}/subtask(id=${task.id})}" method="post">
                                    <div class="mb-2">
                                        <input type="text" class="form-control form-control-sm" name="title"
                                            placeholder="Tiêu đề subtask" required>
                                    </div>
                                    <div class="mb-2">
                                        <input type="text" class="form-control form-control-sm" name="description"
                                            placeholder="Mô tả (tùy chọn)">
                                    </div>
                                    <div class="mb-2">
                                        <select class="form-select form-select-sm" name="assigneeId">
                                            <option value="">Giao cho...</option>
                                            <option th:each="user : ${users}" th:value="${user.id}"
                                                th:text="${user.fullName}">User</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary">Tạo Subtask</button>
                                </form>
                            </div>
                        </div>

                        <div class="card-body p-0">
                            <div th:if="${task.subtasks != null && task.subtasks.size() > 0}">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tiêu đề</th>
                                                <th style="width: 250px;">Mô tả</th>
                                                <th style="width: 130px;">Người thực hiện</th>
                                                <th style="width: 120px;">Trạng thái</th>
                                                <th style="width: 100px;"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="subtask, iterStat : ${task.subtasks}">
                                                <td>
                                                    <span th:text="${subtask.title}"
                                                        th:classappend="${subtask.status.name() == 'DONE'} ? 'text-success fw-semibold'">Title</span>
                                                </td>
                                                <td>
                                                    <small class="text-muted"
                                                        th:text="${subtask.description ?: '-'}">Desc</small>
                                                </td>
                                                <td>
                                                    <small
                                                        th:text="${subtask.assigneeName ?: 'Chưa giao'}">Assignee</small>
                                                </td>
                                                <td>
                                                    <!-- Show status change form only when task is not deleted -->
                                                    <form th:if="${!task.isDeleted}"
                                                        th:action="@{/tasks/{taskId}/subtask/{subtaskId}/status(taskId=${task.id}, subtaskId=${subtask.id})}"
                                                        method="post">
                                                        <input type="hidden" th:name="${_csrf.parameterName}"
                                                            th:value="${_csrf.token}" />
                                                        <select class="form-select form-select-sm" name="status"
                                                            onchange="this.form.submit()"
                                                            style="font-size: 0.75rem; padding: 2px 4px;">
                                                            <option value="TODO"
                                                                th:selected="${subtask.status.name() == 'TODO'}">Chờ xử
                                                                lý</option>
                                                            <option value="IN_PROGRESS"
                                                                th:selected="${subtask.status.name() == 'IN_PROGRESS'}">
                                                                Đang làm</option>
                                                            <option value="DONE"
                                                                th:selected="${subtask.status.name() == 'DONE'}">Hoàn
                                                                thành</option>
                                                            <option value="CANCELLED"
                                                                th:selected="${subtask.status.name() == 'CANCELLED'}">Đã
                                                                hủy</option>
                                                        </select>
                                                    </form>
                                                    <!-- Show status badge only when task is deleted (read-only) -->
                                                    <span th:if="${task.isDeleted}" class="badge"
                                                        th:classappend="'status-' + ${subtask.status.name().toLowerCase()}"
                                                        th:switch="${subtask.status.name()}" style="font-size: 0.7rem;">
                                                        <span th:case="'TODO'">Chờ xử lý</span>
                                                        <span th:case="'IN_PROGRESS'">Đang làm</span>
                                                        <span th:case="'DONE'">Hoàn thành</span>
                                                        <span th:case="'CANCELLED'">Đã hủy</span>
                                                    </span>
                                                </td>
                                                <td class="text-end">
                                                    <!-- Sửa/Xóa buttons - only for Admin or Task Creator AND when task is not deleted -->
                                                    <span
                                                        th:if="${!task.isDeleted && (task.createdById == currentUser.id || isAdmin)}">
                                                        <button type="button"
                                                            class="btn btn-outline-primary btn-sm me-1"
                                                            style="font-size: 0.7rem; padding: 2px 6px;"
                                                            data-bs-toggle="modal"
                                                            th:data-bs-target="'#editSubtaskModal' + ${iterStat.index}">
                                                            Sửa
                                                        </button>
                                                        <button type="button" class="btn btn-danger btn-sm"
                                                            style="font-size: 0.7rem; padding: 2px 6px;"
                                                            th:onclick="'showDeleteSubTaskModal(' + ${task.id} + ', ' + ${subtask.id} + ')'">
                                                            Xóa
                                                        </button>
                                                    </span>

                                                    <!-- Edit Subtask Modal -->
                                                    <div class="modal fade"
                                                        th:id="'editSubtaskModal' + ${iterStat.index}" tabindex="-1">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <form
                                                                    th:action="@{/tasks/{taskId}/subtask/{subtaskId}/update(taskId=${task.id}, subtaskId=${subtask.id})}"
                                                                    method="post">
                                                                    <input type="hidden"
                                                                        th:name="${_csrf.parameterName}"
                                                                        th:value="${_csrf.token}" />
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title">Chỉnh sửa Subtask</h5>
                                                                        <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"></button>
                                                                    </div>
                                                                    <div class="modal-body text-start">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Tiêu đề <span
                                                                                    class="text-danger">*</span></label>
                                                                            <input type="text" class="form-control"
                                                                                name="title" th:value="${subtask.title}"
                                                                                required>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Mô tả</label>
                                                                            <textarea class="form-control"
                                                                                name="description" rows="2"
                                                                                th:text="${subtask.description}"></textarea>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Người thực
                                                                                hiện</label>
                                                                            <select class="form-select"
                                                                                name="assigneeId">
                                                                                <option value="">Chưa giao</option>
                                                                                <option th:each="user : ${users}"
                                                                                    th:value="${user.id}"
                                                                                    th:text="${user.fullName}"
                                                                                    th:selected="${subtask.assigneeId == user.id}">
                                                                                    User</option>
                                                                            </select>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Trạng thái</label>
                                                                            <select class="form-select" name="status">
                                                                                <option value="TODO"
                                                                                    th:selected="${subtask.status.name() == 'TODO'}">
                                                                                    Chờ xử lý</option>
                                                                                <option value="IN_PROGRESS"
                                                                                    th:selected="${subtask.status.name() == 'IN_PROGRESS'}">
                                                                                    Đang làm</option>
                                                                                <option value="DONE"
                                                                                    th:selected="${subtask.status.name() == 'DONE'}">
                                                                                    Hoàn thành</option>
                                                                                <option value="CANCELLED"
                                                                                    th:selected="${subtask.status.name() == 'CANCELLED'}">
                                                                                    Đã hủy</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" class="btn btn-secondary"
                                                                            data-bs-dismiss="modal">Hủy</button>
                                                                        <button type="submit"
                                                                            class="btn btn-primary">Lưu</button>
                                                                    </div>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="p-3 text-center text-muted"
                                th:if="${task.subtasks == null || task.subtasks.size() == 0}">
                                Chưa có subtask nào
                            </div>
                        </div>
                    </div>

                    <!-- Comments -->
                    <div class="card">
                        <div class="card-header">Comments</div>
                        <div class="card-body">
                            <div th:if="${task.comments != null && task.comments.size() > 0}">
                                <div class="comment-item" th:each="comment : ${task.comments}">
                                    <div class="comment-author" th:text="${comment.authorName}">Author</div>
                                    <div class="comment-text" th:text="${comment.content}">Comment</div>
                                    <div class="comment-time"
                                        th:text="${#temporals.format(comment.createdAt, 'dd/MM/yyyy HH:mm')}">Time</div>
                                </div>
                            </div>
                            <div class="text-center text-muted py-3"
                                th:if="${task.comments == null || task.comments.size() == 0}">
                                Chưa có comment nào
                            </div>

                            <!-- Hide comment form when task is deleted -->
                            <form th:if="${!task.isDeleted}" th:action="@{/tasks/{id}/comment(id=${task.id})}"
                                method="post" class="mt-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="content" placeholder="Viết comment..."
                                        required>
                                    <button type="submit" class="btn btn-primary">Gửi</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Assign Task - Only show for task creator and when task is not deleted -->
                    <div class="card mb-4" th:if="${!task.isDeleted && task.createdById == currentUser.id}">
                        <div class="card-header">Giao Task</div>
                        <div class="card-body">
                            <form th:action="@{/tasks/{id}/assign(id=${task.id})}" method="post">
                                <div class="mb-2">
                                    <select class="form-select" name="assigneeId" required>
                                        <option value="">Chọn người thực hiện</option>
                                        <option th:each="user : ${users}" th:value="${user.id}"
                                            th:text="${user.fullName}"
                                            th:selected="${task.assigneeId != null && task.assigneeId == user.id}">User
                                        </option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm w-100">Giao Task</button>
                            </form>
                        </div>
                    </div>

                    <!-- Quick Actions - Only show for users who can update task status and when task is not deleted -->
                    <div class="card mb-4" th:if="${!task.isDeleted && canUpdateTaskStatus}">
                        <div class="card-header">Cập nhật trạng thái</div>
                        <div class="card-body">
                            <form th:action="@{/tasks/{id}/status(id=${task.id})}" method="post">
                                <select class="form-select mb-2" name="status" onchange="this.form.submit()">
                                    <option value="TODO" th:selected="${task.status.name() == 'TODO'}">Chờ xử lý
                                    </option>
                                    <option value="IN_PROGRESS" th:selected="${task.status.name() == 'IN_PROGRESS'}">
                                        Đang thực hiện</option>
                                    <option value="DONE" th:selected="${task.status.name() == 'DONE'}">Hoàn thành
                                    </option>
                                    <option value="CANCELLED" th:selected="${task.status.name() == 'CANCELLED'}">Đã hủy
                                    </option>
                                </select>
                            </form>
                            <a th:href="@{/tasks/{id}/edit(id=${task.id})}"
                                th:if="${task.createdById == currentUser.id || isAdmin}"
                                class="btn btn-outline-primary btn-sm w-100">Chỉnh sửa Task</a>
                        </div>
                    </div>

                    <!-- History -->
                    <div class="card">
                        <div class="card-header">Lịch sử</div>
                        <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                            <div th:if="${task.history != null && task.history.size() > 0}">
                                <div class="history-item px-3" th:each="h : ${task.history}">
                                    <div class="history-text">
                                        <strong th:text="${h.changedByName}">User</strong>
                                        đã thay đổi <strong th:text="${h.fieldName}">field</strong>
                                        thành "<span th:text="${h.newValue}">new</span>"
                                    </div>
                                    <div class="history-time"
                                        th:text="${#temporals.format(h.changedAt, 'dd/MM HH:mm')}">Time</div>
                                </div>
                            </div>
                            <div class="p-3 text-center text-muted"
                                th:if="${task.history == null || task.history.size() == 0}">
                                Chưa có lịch sử
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
            style="background-color: #e8f5e9;">
            <div class="toast-header" style="background-color: #c8e6c9;">
                <strong class="me-auto" id="toastTitle">Thông báo</strong>
                <small id="toastTime">Vừa xong</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
                Nội dung thông báo
            </div>
        </div>
    </div>

    <!-- Firebase Messaging -->
    <script th:src="@{/js/firebase-messaging.js}"></script>

    <!-- Delete Task Confirmation Modal -->
    <div class="modal fade" id="deleteTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận xóa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Bạn có chắc chắn muốn xóa task này không?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <form id="deleteTaskForm" method="post" th:action="@{/tasks/{id}/delete(id=${task.id})}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-danger">Xóa</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Subtask Confirmation Modal -->
    <div class="modal fade" id="deleteSubTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận xóa Subtask</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Bạn có chắc chắn muốn xóa subtask này không?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <form id="deleteSubTaskForm" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-danger">Xóa</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showDeleteTaskModal() {
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteTaskModal'));
            deleteModal.show();
        }

        function showDeleteSubTaskModal(taskId, subTaskId) {
            var form = document.getElementById('deleteSubTaskForm');
            form.action = '/tasks/' + taskId + '/subtask/' + subTaskId + '/delete';
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteSubTaskModal'));
            deleteModal.show();
        }

        document.addEventListener('DOMContentLoaded', function () {
            var successMsg = "[[${success}]]";
            var errorMsg = "[[${error}]]";

            // Clean up thymeleaf output if it's null string
            if (successMsg === "null") successMsg = null;
            if (errorMsg === "null") errorMsg = null;

            if (successMsg) {
                var toastEl = document.getElementById('liveToast');
                var toastBody = document.getElementById('toastBody');
                var toastTitle = document.getElementById('toastTitle');
                var toastHeader = toastEl.querySelector('.toast-header');

                toastBody.innerText = successMsg;
                toastTitle.innerText = "Thành công";
                toastHeader.style.backgroundColor = "#c8e6c9"; // Light green
                toastEl.style.backgroundColor = "#e8f5e9";

                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }

            if (errorMsg) {
                var toastEl = document.getElementById('liveToast');
                var toastBody = document.getElementById('toastBody');
                var toastTitle = document.getElementById('toastTitle');
                var toastHeader = toastEl.querySelector('.toast-header');

                toastBody.innerText = errorMsg;
                toastTitle.innerText = "Lỗi";
                toastHeader.style.backgroundColor = "#ffcdd2"; // Light red
                toastEl.style.backgroundColor = "#ffebee";

                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });
    </script>
</body>

</html>