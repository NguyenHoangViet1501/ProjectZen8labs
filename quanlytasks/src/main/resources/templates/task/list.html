<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>Dashboard | Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" th:href="@{/tasks}">Task Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/tasks}">Tasks</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/notifications}">
                            Thông báo
                            <span class="badge bg-danger" th:if="${unreadCount != null && unreadCount > 0}"
                                th:text="${unreadCount}">0</span>
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"
                            th:text="${currentUser?.fullName ?: 'User'}">User</a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <form th:action="@{/logout}" method="post">
                                    <button type="submit" class="dropdown-item">Đăng xuất</button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="py-4">
        <div class="container">
            <!-- Stats Row -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" th:text="${stats?.todo ?: 0}">0</div>
                        <div class="stat-label">Chờ xử lý</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" th:text="${stats?.inProgress ?: 0}">0</div>
                        <div class="stat-label">Đang thực hiện</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" th:text="${stats?.done ?: 0}">0</div>
                        <div class="stat-label">Hoàn thành</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" th:text="${stats?.cancelled ?: 0}">0</div>
                        <div class="stat-label">Đã hủy</div>
                    </div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="card mb-4">
                <div class="card-body py-2">
                    <form class="row g-2 align-items-center" th:action="@{/tasks}" method="get">
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" name="status">
                                <option value="">Trạng thái</option>
                                <option value="TODO" th:selected="${param.status != null && param.status[0] == 'TODO'}">
                                    Chờ xử lý</option>
                                <option value="IN_PROGRESS"
                                    th:selected="${param.status != null && param.status[0] == 'IN_PROGRESS'}">Đang thực
                                    hiện</option>
                                <option value="DONE" th:selected="${param.status != null && param.status[0] == 'DONE'}">
                                    Hoàn thành</option>
                                <option value="CANCELLED"
                                    th:selected="${param.status != null && param.status[0] == 'CANCELLED'}">Đã hủy
                                </option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" name="priority">
                                <option value="">Độ ưu tiên</option>
                                <option value="HIGH"
                                    th:selected="${param.priority != null && param.priority[0] == 'HIGH'}">Cao</option>
                                <option value="MEDIUM"
                                    th:selected="${param.priority != null && param.priority[0] == 'MEDIUM'}">Trung bình
                                </option>
                                <option value="LOW"
                                    th:selected="${param.priority != null && param.priority[0] == 'LOW'}">Thấp</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" name="tag">
                                <option value="">Chọn Tag</option>
                                <option th:each="t : ${allTags}" th:value="${t.name}" th:text="${t.name}"
                                    th:selected="${param.tag != null && param.tag[0] == t.name}">Tag</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="date" class="form-control form-control-sm" name="dueDateFrom"
                                placeholder="Từ ngày" th:value="${param.dueDateFrom}">
                        </div>
                        <div class="col-md-2">
                            <input type="date" class="form-control form-control-sm" name="dueDateTo"
                                placeholder="Đến ngày" th:value="${param.dueDateTo}">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary btn-sm w-100">Lọc</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tasks Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    Danh sách Task
                    <span class="badge bg-secondary" th:text="${tasks?.totalElements ?: 0}">0</span>
                </h5>
                <div>
                    <a th:href="@{/tasks/export}" class="btn btn-success btn-sm me-2">
                        Xuất Excel
                    </a>
                    <a th:href="@{/tasks/new}" class="btn btn-primary btn-sm">+ Tạo Task mới</a>
                </div>
            </div>

            <!-- Tasks Table -->
            <div class="card" th:if="${tasks != null && tasks.content.size() > 0}">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Tiêu đề</th>
                                <th style="width: 80px;">Độ ưu tiên</th>
                                <th style="width: 110px;">Trạng thái</th>
                                <th style="width: 120px;">Người tạo</th>
                                <th style="width: 120px;">Người thực hiện</th>
                                <th style="width: 90px;">Deadline</th>
                                <th style="width: 150px;">Tags</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="task : ${tasks.content}" style="cursor: pointer;"
                                th:onclick="|window.location.href='/tasks/' + ${task.id}|">
                                <td>
                                    <a th:href="@{/tasks/{id}(id=${task.id})}"
                                        class="text-decoration-none text-dark fw-semibold"
                                        th:text="${task.title}">Title</a>
                                    <div class="text-muted small" th:if="${task.description != null}"
                                        th:text="${#strings.abbreviate(task.description, 50)}">Desc</div>
                                </td>
                                <td>
                                    <span class="badge"
                                        th:classappend="${task.priority.name() == 'HIGH'} ? 'priority-high' : (${task.priority.name() == 'MEDIUM'} ? 'priority-medium' : 'priority-low')"
                                        th:text="${task.priority.name() == 'HIGH'} ? 'Cao' : (${task.priority.name() == 'MEDIUM'} ? 'TB' : 'Thấp')">
                                    </span>
                                </td>
                                <td>
                                    <span class="badge" th:classappend="'status-' + ${task.status.name().toLowerCase()}"
                                        th:switch="${task.status.name()}">
                                        <span th:case="'TODO'">Chờ xử lý</span>
                                        <span th:case="'IN_PROGRESS'">Đang thực hiện</span>
                                        <span th:case="'DONE'">Hoàn thành</span>
                                        <span th:case="'CANCELLED'">Đã hủy</span>
                                    </span>
                                </td>
                                <td th:text="${task.createdByName}">Creator</td>
                                <td th:text="${task.assigneeName ?: 'Chưa giao'}">Assignee</td>
                                <td
                                    th:text="${task.dueDate != null} ? ${#temporals.format(task.dueDate, 'dd/MM/yyyy')} : '-'">
                                    Date</td>
                                <td>
                                    <span th:if="${task.tags != null && task.tags.size() > 0}">
                                        <span class="badge bg-secondary me-1" th:each="tag : ${task.tags}"
                                            th:text="${tag}" style="font-size: 0.7em;">tag</span>
                                    </span>
                                    <span th:if="${task.tags == null || task.tags.size() == 0}"
                                        class="text-muted">-</span>
                                </td>
                                <td class="text-end" style="width: 80px;" onclick="event.stopPropagation()">
                                    <button type="button" class="btn btn-danger btn-sm"
                                        th:if="${task.createdById == currentUser.id || isAdmin}"
                                        th:onclick="'confirmDelete(' + ${task.id} + ')'">
                                        Xóa
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" th:if="${tasks == null || tasks.content.size() == 0}">
                <h5>Chưa có task nào</h5>
                <p>Bắt đầu tạo task đầu tiên của bạn!</p>
                <a th:href="@{/tasks/new}" class="btn btn-primary">Tạo Task mới</a>
            </div>

            <!-- Pagination & Record Count - Always show when there are records -->
            <div class="mt-4 d-flex justify-content-between align-items-center"
                th:if="${tasks != null && tasks.content.size() > 0}">
                <small class="text-muted">
                    Hiển thị <strong th:text="${tasks.number * 12 + 1}">1</strong> -
                    <strong th:text="${tasks.number * 12 + tasks.content.size()}">10</strong>
                    trên tổng <strong th:text="${tasks.totalElements}">0</strong> bản ghi
                </small>

                <ul class="pagination pagination-sm mb-0" th:if="${tasks.totalPages > 1}">
                    <li class="page-item" th:classappend="${tasks.first} ? 'disabled'">
                        <a class="page-link"
                            th:href="@{/tasks(page=${tasks.number - 1}, status=${param.status}, priority=${param.priority})}">«
                            Trước</a>
                    </li>
                    <th:block th:each="i : ${#numbers.sequence(0, tasks.totalPages - 1)}">
                        <li class="page-item"
                            th:if="${tasks.totalPages <= 7 || i < 3 || i >= tasks.totalPages - 2 || (i >= tasks.number - 1 && i <= tasks.number + 1)}"
                            th:classappend="${i == tasks.number} ? 'active'">
                            <a class="page-link"
                                th:href="@{/tasks(page=${i}, status=${param.status}, priority=${param.priority})}"
                                th:text="${i + 1}">1</a>
                        </li>
                        <li class="page-item disabled" th:if="${tasks.totalPages > 7 && i == 3 && tasks.number > 3}">
                            <span class="page-link">...</span>
                        </li>
                    </th:block>
                    <li class="page-item" th:classappend="${tasks.last} ? 'disabled'">
                        <a class="page-link"
                            th:href="@{/tasks(page=${tasks.number + 1}, status=${param.status}, priority=${param.priority})}">Sau
                            »</a>
                    </li>
                </ul>

                <small class="text-muted" th:if="${tasks.totalPages <= 1}">
                    Trang 1 / 1
                </small>
            </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận xóa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Bạn có chắc chắn muốn xóa task này không? Hành động này không thể hoàn tác.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <form id="deleteForm" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-danger">Xóa</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
            style="background-color: #e8f5e9;">
            <div class="toast-header" style="background-color: #c8e6c9;">
                <strong class="me-auto" id="toastTitle">Thông báo</strong>
                <small id="toastTime">Vừa xong</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
                Nội dung thông báo
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function confirmDelete(taskId) {
            var deleteForm = document.getElementById('deleteForm');
            deleteForm.action = '/tasks/' + taskId + '/delete';
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }
    </script>
    <!-- Firebase Messaging -->
    <script th:src="@{/js/firebase-messaging.js}"></script>
</body>

</html>